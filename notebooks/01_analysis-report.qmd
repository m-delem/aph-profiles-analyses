---
title: Data Analysis Report
subtitle: Uncovering spatial and verbal cognitive profiles in aphantasia through unsupervised clustering
# setting for proper numbering of sections
crossref: 
  chapters: true
  custom:
    - kind: float
      key: suppfig
      reference-prefix: Figure S
      space-before-numbering: false
    - kind: float
      key: supptbl
      reference-prefix: Table S
      space-before-numbering: false
supptbl-cap-location: top
echo: false # do not show the code unless explicitly asked
params:
  save_figures: true
format: html
---

::: {.callout-note collapse="true"}
# Packages and pipeline

```{r}
#| label: setup
#| echo: true
#| code-fold: false

if (!requireNamespace("pacman")) install.packages("pacman")
pacman::p_load(
  conflicted, 
  here,
  fs, 
  ggplot2,
  mclust,
  NbClust,
  patchwork,
  purrr,
  sessioninfo
)

# source all our functions
dir_ls(here("R"), type = "file", recurse = TRUE) |> walk(source)

# resolve package conflicts
conflicts_prefer(
  dplyr::filter(), 
  dplyr::select(),
  scales::rescale(), 
  purrr::map(),
  .quiet = TRUE
  )
```

Most of the steps of the data analysis were performed using functions defined in 
external R scripts in the `R/` directory (loaded in the chunk above). 
The pipeline below runs all of these functions sequentially, sometimes saving 
heavy computations along the way. This pipeline is designed to be fully 
reproducible by anyone using the `renv` R environment from the project that has
the raw JATOS data stored in the `data/raw-data/` directory.

```{r}
#| label: pipeline
#| echo: true
#| code-summary: Pipeline for the data analysis

# load the data
df <- import_jatos_data()$data_final

# compute/save or load existing VVIQ group models
path_g_models <- here("data/r-data-structures/group_models.rds")
if (!file.exists(path_g_models)) {
  
  group_models <-
    df |>
    select(group, age, vviq:score_comprehension) |> 
    get_long_format() |> 
    model_groups()
  
  saveRDS(group_models, path_g_models)
  
} else group_models <- readRDS(path_g_models)

# correlate variables
corrs_simple  <- correlate_vars(df, partial = FALSE, correction = "bonferroni")
corrs_partial <- correlate_vars(df, partial = TRUE,  correction = "bonferroni")

# variables selected for clustering
selected_vars <- c(
  "visual_imagery", "sensory_imagery", "spatial_imagery", "verbal_strategies",
  "fluid_intelligence", "verbal_reasoning", "span_spatial"
)

# checking statistical cluster tendency and number of clusters
hopkins <- 
  (df |> 
  reduce_vars() |>
  select(any_of(selected_vars)) |>
  get_clust_tendency(n = 95))$hopkins_stat

nb_clusters <- 
  df |> 
  reduce_vars() |> 
  select(any_of(selected_vars)) |>
  n_clusters() |> 
  as.data.frame() |> 
  mutate(n_Clusters = as.factor(n_Clusters))

# compute/save or load existing model of the evolution of the number of clusters
path_n_models <- here("data/r-data-structures/nb_clusters_evolution.rds")
if (!file.exists(here(path_n_models))) {
  
  nb_clusters_evolution <- model_nb_clusters(df, selected_vars)
  
  saveRDS(nb_clusters_evolution, here(path_n_models))
  
} else {
  nb_clusters_evolution <- readRDS(here(path_n_models))
}

# cluster the data
clustering <- 
  df |> 
  reduce_vars() |> 
  select(any_of(selected_vars)) |>
  Mclust(G = 3, verbose = FALSE)

# compute/save or load existing cluster models
path_c_models <- here("data/r-data-structures/cluster_models.rds")
if (!file.exists(path_c_models)) {
  
  cluster_models <-
    df |> 
    add_cluster_vars(clustering) |>
    select(
      cluster, age, visual_imagery:spatial_span, 
      wcst_accuracy, score_comprehension
    ) |>
    get_long_format() |> 
    model_clusters()
  
  saveRDS(cluster_models, path_c_models)
  
} else cluster_models <- readRDS(path_c_models)

# compute/save or load existing subcluster models
path_sc_models <- here("data/r-data-structures/subcluster_models.rds")
if (!file.exists(path_sc_models)) {
  
  subcluster_models <-
    df |> 
    add_cluster_vars(clustering) |>
    select(
      subcluster, age, visual_imagery:spatial_span, 
      wcst_accuracy, score_comprehension
    ) |>
    get_long_format() |> 
    model_subclusters()
  
  saveRDS(subcluster_models, path_sc_models)
  
} else subcluster_models <- readRDS(path_sc_models)
```
:::

# VVIQ group analysis

## Modelling

We first analysed the data in light of the VVIQ groups, examining differences between aphantasics and controls In order to model our variables with the VVIQ groups, we adjusted generalized linear models also controlling the effect of age on all variables to isolate the group effect:

$$Variable = \alpha  + \beta_{1} \cdot Group \times \beta_{2} \cdot Age + \epsilon$$

::: {#supptbl-group-modelling-results}
```{r}
#| label: group-models-table

group_models |> 
  select(
    Variable, 
    Control, Aphantasic, 
    Difference,  `95% CI`, `$log(BF_{10})$`
    ) |>
  knitr::kable()
```

Means and standard deviations of the scores of each VVIQ group for every variable. The score differences, their 95% Credible Interval and weight of evidence are reported for each variable.
:::

\newpage

## Visualizations

::: {#suppfig-group-violin-plots .column-page-inset}
```{r}
#| label: group-violin-plots
#| fig-width: 8
#| fig-height: 3.5

plot_groups_violins(df)
  
if (params$save_figures) {
  ggsave(
    filename = here("figures/group-violins.pdf"), 
    # plot = p,
    device = "pdf",
    width = 180,
    height = 80,
    units = "mm",
    dpi = 600
    )
}
```

Standardised scores of the two VVIQ groups on all the questionnaires and tasks. The scores have been rescaled and standardised between 0 and 1 to be represented on the same scale. The coloured shapes represent the distribution of the scores in each group. The black dots represent the mean of each group, while the black bars represent the standard deviations. The stars represent weight of evidence thresholds in favour of a difference between the groups: \* = "*Substantial evidence*", \*\* = "*Strong evidence*", \*\*\* = "*Decisive evidence*".
:::

# Cluster analysis

## Correlation analysis

::: {#suppfig-correlation-plots .column-page-inset}
```{r}
#| label: correlation-plots
#| fig-width: 19.5
#| fig-height: 12.5

plot_correlations(corrs_simple)
if (params$save_figures) ggsave(here("figures/correlations-simple.png"), dpi = 600)

plot_correlations(corrs_partial)
if (params$save_figures) ggsave(here("figures/correlations-partial.png"), dpi = 600)
```

Correlation matrix and graph of all the original variables (standardized beforehand)/ The matrix shows the correlation coefficients between all the variables, while the graph shows the significant correlations between them. The colours represent the strength and direction of the correlation: red for negative and green for positive. SRI and Raven Matrices scores are at the heart of a network, but they were only merged together (1) because of their higher correlation, (2) because they have the same format (cognitive test with MCQs) and (3) based on domain knowledge that non-verbal and spatial reasoning are very close constructs.
:::

## Number of clusters

The number of clusters was determined using the `NbClust` package [@R-NbClust], which provides 30 indices for determining the number of clusters in a dataset. The most common indices are the silhouette, Dunn, and gap statistics. The `NbClust` package provides the optimal number of clusters based on the majority rule of the indices. The results of this analysis are displayed in @suppfig-nbclust.

::: {#suppfig-nbclust .column-page-inset}
```{r}
#| label: show-nbclust-plots
#| fig-width: 16
#| fig-height: 6.5

plot_nb_clust(nb_clusters, nb_clusters_evolution)

if (params$save_figures) ggsave(here("figures/cluster-n.png"), dpi = 600)
```

Determination of the optimal number of clusters through an unsupervised "agreement" method.
:::

## Clustering

::: {#supptbl-cluster-repartition}
```{r}
#| label: show-cluster-repartition

df |> 
  add_cluster_vars(clustering) |> 
  group_by(group) |> 
  count(Cluster = cluster) |> 
  pivot_wider(names_from = group, values_from = n, values_fill = 0) |> 
  knitr::kable()
```
:::

## Modelling

::: {#supptbl-cluster-modelling-results}
```{r}
#| label: show-cluster-models-table

# table of the means of each cluster
cluster_models |>
  select(
    Variable, 
    `Cluster A`, `Cluster B`, `Cluster C`,
    Cluster, Age, `Cluster $\\times$ Age`,
  ) |>
  unique() |>
  knitr::kable()

# table of the contrasts between clusters
cluster_models |>
  select(
    Variable, 
    `Cluster 1`, `Cluster 2`,
    Difference,  `95% CI`, `$log(BF_{10})$`
  ) |>
  knitr::kable()

subcluster_models |>
  select(
    Variable, 
    `Subcluster 1`, `Subcluster 2`,
    Difference,  `95% CI`, `$log(BF_{10})$`
  ) |>
  knitr::kable()
```
:::

## Visualizations

::: {#suppfig-cluster-radar-plots .column-page-inset}
```{r}
#| label: cluster-radar-plots
#| fig-width: 15
#| fig-height: 8

plot_clusters_radars(df, clustering)

if (params$save_figures) ggsave(here("figures/cluster-radar.png"), dpi = 600)
```
:::

```{r}
#| label: cluster-violin-plots
#| fig-width: 14
#| fig-height: 7
#| include: false

p1 <- plot_clusters_violins(df, clustering, Cluster)

# p1
# if (params$save_figures) ggsave(here("figures/cluster-violins.png"), dpi = 600)
```

```{r}
#| label: subcluster-violin-plots
#| fig-width: 14
#| fig-height: 7
#| include: false

p2 <- plot_clusters_violins(df, clustering, Subcluster) +
  theme(plot.margin = margin(1, 0, 0, 0, "cm"))

# p2
# if (params$save_figures) ggsave(here("figures/subcluster-violins.png"), dpi = 600)
```

::: {#suppfig-cluster-violin-joint-plots .column-page-inset}
```{r}
#| label: cluster-violin-plots-joint
#| fig-width: 14
#| fig-height: 14

p1 / p2 + plot_annotation(tag_levels = "A") & 
  theme(plot.tag = element_text(size = 26))

if (params$save_figures) ggsave(here("figures/cluster-violins-joint.png"), dpi = 600)
```
:::

# Education, field and occupation

## Groups

::: {#supptbl-group-association-tests}
```{r}
#| label: group-association-tests

model_life_associations(df, clustering, group) |> 
  select(Variable, log_bf10) |> 
  rename(`$log(BF_{10})$` = log_bf10) |> 
  knitr::kable()
```
:::

::: {#suppfig-group-life-plots .column-page-inset}
```{r}
#| label: group-life-plots
#| fig-width: 16
#| fig-height: 6.5

plot_life(df, clustering, group)

if (params$save_figures) ggsave(here("figures/group-life.png"), dpi = 600)
```
:::

## Clusters

::: {#supptbl-cluster-association-tests}
```{r}
#| label: cluster-association-tests

model_life_associations(df, clustering, cluster) |>
  select(Variable, log_bf10) |> 
  rename(`$log(BF_{10})$` = log_bf10) |> 
  knitr::kable()
```

```{r}
df |> 
  add_cluster_vars(clustering) |> 
  group_by(cluster) |>
  filter(group == "Aphantasic") |>
  count(field) |> 
  pivot_wider(names_from = cluster, values_from = n) |> 
  rename("B" = 2, "C" = 3) |>
  mutate(across(c(B, C), ~replace_na(.x, 0))) |> 
  mutate(total = B + C) |> 
  rename_with(~ paste("Aph. in ", .), B:C) |> 
  rename("Field" = field, "Total Aph." = total) |> 
  knitr::kable()
```
:::

::: {#suppfig-cluster-life-plots .column-page-inset}
```{r}
#| label: cluster-life-plots
#| fig-width: 16
#| fig-height: 6.5

plot_life(df, clustering, cluster)

if (params$save_figures) ggsave(here("figures/cluster-life.png"), dpi = 600)
```
:::

## Subclusters

::: {#supptbl-subcluster-association-tests}
```{r}
#| label: subcluster-association-tests

model_life_associations(df, clustering, subcluster) |>
  select(Variable, log_bf10) |> 
  rename(`$log(BF_{10})$` = log_bf10) |> 
  knitr::kable()
```
:::

::: {#suppfig-subcluster-life-plots .column-page-inset}
```{r}
#| label: subcluster-life-plots
#| fig-width: 16
#| fig-height: 6.5

plot_life(df, clustering, subcluster)

if (params$save_figures) ggsave(here("figures/subcluster-life.png"), dpi = 600)
```
:::

&nbsp;
&nbsp;
&nbsp;

::: {.callout-note collapse="true"}
# Session information

```{r}
#| label: session-information
#| echo: false

sessioninfo::session_info(pkgs = "attached")
```
:::