```{r}
if (!requireNamespace("pacman")) install.packages("pacman")
pacman::p_load(
  BiocManager,
  conflicted, 
  here,
  factoextra,
  fs, 
  ggplot2,
  mclust,
  NbClust,
  patchwork,
  purrr,
  sessioninfo
)

dir_ls(here("R"), type = "file", recurse = TRUE) |> walk(source)

# resolve package conflicts
conflicts_prefer(
  dplyr::filter(), 
  dplyr::select(),
  scales::rescale(), 
  purrr::map(),
  .quiet = TRUE
  )
```

# Pipeline

```{r}
#| label: load-data

df <- import_jatos_data()$data_final
```

```{r}
#| label: correlations

corrs_simple  <- correlate_vars(df, partial = FALSE, correction = "bonferroni")
corrs_partial <- correlate_vars(df, partial = TRUE,  correction = "bonferroni")
```

```{r}
#| label: clustering
#| warning: false

selected_vars <- c(
  "visual_imagery", "sensory_imagery", "spatial_imagery", "verbal_strategies",
  "fluid_intelligence", "verbal_reasoning", "span_spatial"
)

bic <- df |> scale_reduce_vars() |> select(any_of(selected_vars)) |> mclustBIC()

clustering <- 
  df |> 
  scale_reduce_vars() |> 
  select(any_of(selected_vars)) |>
  Mclust(verbose = FALSE)

df2 <- merge_clusters(df_raw = df, df_red = scale_reduce_vars(df), clustering)

df_long <- df2 |> scale_vars() |> get_longer()
```

```{r}
#| label: modelling
#| warning: false

models_path <- here("data/r-data-structures/models.rds")

if (!file_exists(models_path)) {
  group_models      <- df2 |> get_longer() |> model_groups(groups = Group)
  cluster_models    <- df_long |> model_groups(groups = Cluster)
  subcluster_models <- df_long |> model_groups(groups = Subcluster)
  
  models <- list(
    group_models      = group_models,
    cluster_models    = cluster_models,
    subcluster_models = subcluster_models
  )
  
  saveRDS(models, models_path)
  
  } else models <- readRDS(models_path)
```

```{r}
#| label: plots
#| warning: false

p_groups_violins <- plot_violins(df_long, var_selection = "original")
p_groups_radar   <- plot_radars(df_long, Group,  var_selection = "original")

p_partial <- plot_correlations(corrs_partial)
p_simple  <- plot_correlations(corrs_simple)

p_bic <- plot_clusters_bic(clustering)
p_clusters <- 
  plot_radars(df_long, Cluster, r_off = 6) + 
  plot_radars(df_long, Subcluster, l_off = 6)

ggsave_double_col("figures/groups-violins.pdf", p_groups_violins, height = 88)
ggsave_single_col("figures/groups-radar.pdf",   p_groups_radar,   height = 88)

ggsave_double_col("figures/correlations-partial.pdf", p_partial, height = 120)
ggsave_double_col("figures/correlations-simple.pdf",  p_simple,  height = 120)

ggsave_single_col("figures/clusters-bic.pdf",    p_bic,      height = 88)
ggsave_double_col("figures/clusters-radars.pdf", p_clusters, height = 90)
```

# Cluster repartition

```{r}
#| label: clsuter-repartition

df_long |> 
  select(id, Subcluster, Variable, value) |> 
  filter(Variable == "VVIQ") |> 
  distinct() |>
  group_by(Subcluster) |> 
  reframe(
    n = n(),
    VVIQ_std = mean(value) |> round(2)
  )
```

```{r}
model_lives(df2, group)      |> select(1, 4)
model_lives(df2, cluster)    |> select(1, 4)
model_lives(df2, subcluster) |> select(1, 4)
```

